---
title: "Harmful Effects of Severe Weather"
author: "Andrew Luyt"
output: 
    html_document:
        theme: united
        highlight: pygments
        keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
*Most recent update: `r Sys.Date()`*

## Synopsis
*Immediately after the title, there should be a synopsis which describes and 
summarizes your analysis in at most 10 complete sentences.*

## Data Processing

We'll load libraries first and 
```{r libraries}
# One function from data.table is also required, "fread". We won't load the
# entire package because its namespace overlaps some other functions we use.
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(kableExtra))  # table formatting tools

# global table styling options set here by overriding kable()
kable <- function(data, ...) {
    knitr::kable(data, format.args = list(big.mark = ","), ...) %>% 
        kable_classic(full_width=FALSE, position="left")
}
```

Next we load the data, rename two variables with cumbersome names,
remove two variables, and standardize the values of `evtype` to lowercase
with no extra spaces.
```{r load-data, cache=TRUE}
df <- as_tibble(data.table::fread(file = "repdata_data_StormData.csv.bz2"))
df <- rename(df, state_num = STATE__, longitude_e = LONGITUDE_)
names(df) <- tolower(names(df))
# these variables are all 0 and all NA, respectively
df <- select(df, -c(county_end, countyendn))

# standardize `evtype` to lowercase, removing spaces at beginning and end
# and removing extra internal spaces
df$evtype <- tolower(str_squish(df$evtype))
```

### Correcting `propdmgexp` and `cropdmgexp`

Damage amounts are represented in an unusual way. They are expressed in
scientific notation, with the base and exponent stored in separate variables.

The exponents, `propdmgexp` and `cropdmgexp`,  are supposed to
represent a power of 10, which is multiplied by `propdmg` or `cropdmg`
respectively to express a final damage amount. However, they actually
contain unusual values:

```{r check_exponent_features}
sort(union(unique(df$propdmgexp), unique(df$cropdmgexp)))
```

After some investigation, it appears varying data entry standards or data
entry error has resulted in this state of affairs. A power of 10 will be
assigned to replace each of these symbols.
[*For a more complete discussion, see [this Rpubs document](https://rstudio-pubs-static.s3.amazonaws.com/58957_37b6723ee52b455990e149edde45e5b6.html).*]

* `empty string`: 0
* `+` or `?`: 1
* `0-9`: 10
* `hH`: 100   "hundred"
* `kK`: 1000  "kilo"
* `mM`: 10^6  "million"
* `bB`: 10^9  "billion"
* `-`: NA 

```{r correct_exponent_features, cache=TRUE}
# Perform the substitution described above
old <- c("-", "?", "+", "0", "1", "2", "3", "4", "5", "6", "7", "8", "B", "H", "K", "M", "")
new <- c(NA,   1,   1,   10,  10,  10,  10,  10,  10,  10,  10,  10, 1e9, 1e2, 1e3, 1e6, 0)

ctmp <- toupper(df$cropdmgexp)
ptmp <- toupper(df$propdmgexp)
cnew <- rep(NA_integer_, length(ctmp)) # new vectors will be integers
pnew <- rep(NA_integer_, length(ptmp))

for (i in 1:length(old)) {
    cnew[ctmp == old[[i]]] <- new[[i]]
    pnew[ptmp == old[[i]]] <- new[[i]]
}

df$cropdmgexp <- cnew
df$propdmgexp <- pnew
rm(ctmp, ptmp, cnew, pnew, old, new, i)

```

### Fixing `evtype`

`evtype` may be the most important variable in our dataset. It is the
variable that categorizes each event as "tornado", "flood" and so forth.
Later we'll use `evtype` to
aggregate human and financial damage for each type of weather event and it's
important that they reflect the categories we think they do.

In the NOAA documentation there are 48 official `evtype` values, corresponding
to the various weather events they wish to record data for.

In the dataset however, almost 1000 unique values exist. An examination
shows this to have probably resulted from manual data entry. For example,
here we list types relating to blizzards.

```{r demonstrate_data_entry_problems}
df %>% 
    count(evtype) %>% 
    arrange(desc(n)) %>% 
    filter(str_detect(evtype, "blizzard")) %>% 
    head(n=7) %>% 
    kable(caption = 'A sample of blizzard-related evtypes')
```

We can see that `"blizzard"` labels most of the observations, with a small number of
other observations given similar-sounding labels. These observations should probably be
a part of `"blizzard"`. With over 1000 types in the dataset, We'd like to know 
if this example represents a systematic problem. 

We constructed a list of official evtypes from NOAA documentation and
stored it in `evtypes.txt`. We wish to know
**what proportion of records have a non-standard `evtype` value?**

```{r find_proportion_of_bad_types}
types <- tolower(readLines("evtypes.txt")) # a vector of standard values
df %>% filter(! evtype %in% types) %>% nrow() / nrow(df)
```
About 30% of the data is using some other label for `evtype`. This is
a significant number and could certainly skew our analysis.
e.g. if one major event type
were split into many smaller types it might no longer appear to be a major
cause of damage.

Let's count how many non-standard `evtype` strings label 100 or more observations
in the dataset. As a reminder, there are `r nrow(df)` observations in total.

```{r count_types_to_fix_manually}
fixtypes <- df %>% 
    filter(! evtype %in% types) %>%
    count(evtype) %>% 
    arrange(desc(n)) %>% 
    filter(n >= 100) %>% 
    pull(evtype)
length(fixtypes)
```

This is good news, we won't have to fix over 900 possible errors. Fixing 
the 32 most common should ensure a much more accurate analysis.

What we will do is work through these 32 types systematically and assign them
the correct `evtype`, using the NOAA documentation and some common sense. 
The rest of the non-standard labels we will disregard for having too
small an effect on the analysis to matter. Let's first look at the labels
we'll fix.

```{r show_types_to_fix}
kable(matrix(fixtypes, nrow = 8), caption = "The 32 most important evtypes to correct")
```

Now we'll fix these incorrect labels by reassigning the observation to the
correct `evtype`.

```{r create_types_fixlist}
# map official evtypes to a vector of some incorrect names for that type
fixlist <- list(
    "thunderstorm wind" = c("tstm wind", "thunderstorm winds", "tstm wind/hail", 
                            "wind", "dry microburst"),
    "marine thunderstorm wind" = c("marine tstm wind"),
    "flood" = c("urban/sml stream fld", "flood/flash flood", "urban flood",
                "river flood", "flooding"),
    "flash flood" = c("flash flooding"),
    "coastal flood" = c("coastal flooding"),
    "high wind" = c("high winds"),
    "strong wind" = c("strong winds"),
    "wildfire" = c("wild/forest fire"),
    "winter weather" = c("winter weather/mix"),
    "extreme cold/wind chill" = c("extreme cold", "extreme windchill"),
    "heavy snow" = c("snow", "light snow", "moderate snowfall"),
    "debris flow" = c("landslide"),
    "dense fog" = c("fog"),
    "rip current" = c("rip currents"),
    "excessive heat" = c("unseasonably warm", "record warmth"),
    # from docs: "..caused by any combination of...high astronomical tide..."
    "storm surge/tide" = c("storm surge", "astronomical high tide"),  
    "high surf" = c("heavy surf/high surf"),
    "winter weather" = c("freezing rain"),
    "hurricane (typhoon)" = c("hurricane")
)

tmp <- df$evtype

# replace all the bad evtypes with official evtypes
for (officialtype in names(fixlist)) {
    for (badtype in fixlist[[officialtype]]) {
        tmp[grep(pattern = badtype, x = tmp)] <- officialtype
    }
}
df$evtype <- tmp
rm(tmp)
```

Previously, almost 30% of records had an incorrect `evtype`. Let's recalculate 
that proportion.
```{r how_effective_was_fixing_names}
df %>% filter(! evtype %in% types) %>% nrow() / nrow(df)
```

Excellent! Now only 0.3% of records have some unusual `evtype` from data
entry errors. Let's make one more test. It's *possible* these small number of
observations are actually large in terms of human or financial damage. Let us
compare the sum of fatalities, injuries, property damage, and crop damage of these
remaining records to the whole.

```{r check_nonstandard_sums}
results <- df %>% 
    mutate(property = propdmg*propdmgexp, crops = cropdmg*cropdmgexp) %>% 
    group_by("standard_evtypes" = evtype %in% types) %>% 
    summarise(across(c(fatalities, injuries, property, crops),
                     ~sum(., na.rm=TRUE))) %>% 
    t()
results <- results[-1, ]
colnames(results) <- c("sum.non.standard", "sum.standard")
as_tibble(results) %>% 
    mutate(non.standard.proportion = sum.non.standard / (sum.non.standard + sum.standard),
           class = rownames(results)) %>% 
    select(class, everything()) %>% 
    kable()
```

With these non-standard cases making up at most 3.3% of their total, the dataset
is in much better condition than it was in raw form.
We'll continue the analysis with this imperfect but much-improved dataset, 
assuming that this small proportion of error won't significantly skew our results.

## Results

#### Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?


Here we sum the fatalities and injuries across `evtype`, select the ten largest
sums, and then plot the results.

```{r injuries_fatalities, cache=TRUE}
top_fatalities <- df %>% 
    group_by(evtype) %>% 
    summarise(fatalities = sum(fatalities, na.rm = TRUE)) %>% 
    arrange(desc(fatalities)) %>% 
    slice_head(n = 10)

top_injuries <- df %>% 
    group_by(evtype) %>% 
    summarise(injuries = sum(injuries, na.rm = TRUE)) %>% 
    arrange(desc(injuries)) %>% 
    slice_head(n = 10)
```

```{r graph_injuries_fatalities, fig.height=5, fig.width=7}
par(mfrow = c(1,2), mar=c(c(8, 4, 4, 2) + 0.1), cex.axis=.9)
barplot(top_fatalities$fatalities, names.arg = top_fatalities$evtype, las=2,
        main="Fatalities: top causes")
barplot(top_injuries$injuries, names.arg = top_injuries$evtype, las=2,
        main="Injuries: top causes")
```

In terms of both fatalities and injuries, **tornadoes are the most destructive
events to human health** in this dataset. 

#### Hurricanes?

There appears to be something missing in the above graphs. Knowing something of 
destructive US weather events one must ask **"Where are the hurricanes?"**

There is an important note in the FAQ:

>The fatalities, injuries, and damage amounts appearing in tropical cyclone events are
attributed only to wind damage experienced in the coastal counties/parishes listed. Other
tropical cyclone related events such as tornadoes and flooding are listed within their
separate event types.

**i.e. the deaths and damage from hurricanes have deliberately been split up into 
multiple evtypes** and will show up as part of floods, lightning, wind, *etc.*
Hurricane-spawned tornadoes are also included in the tornado events graphed above.
From the point of view of this dataset, hurricanes may be understood as a
'meta-event' that *causes* other events.

It is also worth noting that some similar events have different official
`evtype`s, e.g. `excessive heat` and `heat`, both of which show up in
the graphs above.  We will leave this as is, having verified that they
represent different categories in the NOAA documentation.

#### Across the United States, which types of events have the greatest economic consequences?

We proceed as earlier, summing property and crop damage across all evtypes.

```{r calculate_damages, fig.height=5, fig.width=7}
top_property_dmg <- df %>% 
    group_by(evtype) %>% 
    summarise(property = sum(propdmg * propdmgexp, na.rm = TRUE)) %>% 
    arrange(desc(property)) %>% 
    slice_head(n = 10)
top_crop_dmg <- df %>% 
    group_by(evtype) %>% 
    summarise(crop = sum(cropdmg * cropdmgexp, na.rm = TRUE)) %>% 
    arrange(desc(crop)) %>% 
    slice_head(n = 10)

par(mfrow=c(1,2), mar=c(c(9, 5, 4, 2) + 0.1), cex.axis=.9, mgp = c(4, 1, 0))
barplot(top_property_dmg$property, names.arg = top_property_dmg$evtype, las=2,
        main="Property damage: top causes", ylab = "US Dollars")
barplot(top_crop_dmg$crop, names.arg = top_crop_dmg$evtype, las=2,
        main="Crop damage: top causes")
```

As mentioned in the previous section, the amounts for **hurricane (typhoon)** 
are **only** for wind damage on coastal communities. Hurricane-caused flooding,
*etc.* are grouped into separate `evtypes`.

<br/>
<hr />
To aid reproducibility, here is the session environment at time of publishing.
```{r}
sessionInfo()
```

